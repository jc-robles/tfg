<!DOCTYPE  html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IMU Data Process</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="/js/SplitUtils.js"></script>
</head>
<body>

<script>
let myCharts = [];

function dataValue(label, data, color) {
    return {
        label: label,
        data: data,
        fill: false,
        borderColor: color,
        tension: 0,
        borderWidth: 1
    };
}

function newGraphic(idElement, dataLabels, data) {
        const arrayRange = (start, stop, step) =>
            Array.from(
                { length: (stop - start) / step + 1 },
                (value, index) => start + index * step
            );

        let color = ['rgb(75, 192, 192)', 'rgb(153, 102, 255)', 'rgb(255, 159, 64)', 'rgba(255, 99, 132, 0.2)']
        let dataValues = [];
        for (var i = 0; i < data.length; i++) {
          dataValues.push(dataValue(dataLabels[i], data[i], color[i]));
        }

        let myChart = new Chart(document.getElementById(idElement), {
        type: 'line',
        data: {
            labels: arrayRange(1, data[0].length, 1).map(String),
            datasets: dataValues
        },
        options: {
          scales: {
            y: {
                min: Math.min.apply(Math, data),
                max: Math.max.apply(Math, data)
            }
          }
        }
        });

        window.addEventListener('resize', function() {myChart.resize();});
        myCharts.push(myChart)
}

$(document).ready(function() {
    $('#splitTest').on("click", function() {
        $('#listTest').append('<li class="nav-item"><a class="nav-link text-body">Test 3</a></li>');
        sendSplit();
    });

    $('#test1').on("click", function() {
        $("#myChart").hide();
        $('#mainTest').removeClass("active")
        $('#test1').addClass("active")
        $('#myChart2').show();
    });

    $('#mainTest').on("click", function() {
        $("#myChart2").hide();
        $('#test1').removeClass("active")
        $('#mainTest').addClass("active")
        $('#myChart').show();
    });

    $('#deleteTest').on("click", function() {
        myCharts.forEach(function(elemento, indice, array) {
            elemento.destroy();
        })
    });

    $('#formUploadFile').submit(function(event) {
        myCharts.forEach(function(elemento, indice, array) {
            elemento.destroy();
        })

        $("#mainTable").show();
        $("#spinner").show();
        $("#closeUploadModal").click();
        event.preventDefault();
        var formData = new FormData(this);
        $.ajax({
            url: '/upload-file',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                $("#spinner").hide();
                $("#accordionPanelsStayOpenExample").show();

                newGraphic('accelerometerGraphic',['Accelerometer X', 'Accelerometer Y','Accelerometer Z' ] ,[data.accelerometerX, data.accelerometerY, data.accelerometerZ]);
                newGraphic('gyroscopeGraphic',['Gyroscope X', 'Gyroscope Y','Gyroscope Z'] ,[data.gyroscopeX, data.gyroscopeY, data.gyroscopeZ]);
                newGraphic('quaternionGraphic',['Quaternion W', 'Quaternion X', 'Quaternion Y','Quaternion Z'] ,[data.quaternionW, data.quaternionX, data.quaternionY, data.quaternionZ]);

                $('#formUploadFile')[0].reset();
            }
        });
    });
});
</script>

<div class="container-fluid px-0">
    <nav class="navbar navbar-expand-lg bg-dark" data-bs-theme="dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">IMU Data Process</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-link active" aria-current="page" data-bs-toggle="modal" data-bs-target="#exampleModal" href="#">Upload file test</a>
                    <a class="nav-link active" aria-current="page" href="#" id="createTest">Create test</a>
                </div>
            </div>
        </div>
    </nav>
</div>
<div class="container mt-5" id="mainTable" style="display: none;">
    <div class="row">
        <div class="col">
            <ul class="nav nav-tabs" id="listTest">
                <li class="nav-item">
                    <a class="nav-link text-body active" aria-current="page" href="#" id="mainTest">Raw input file</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-body" href="#" id="test1">Test 1</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-body" href="#">Test 2</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-body">Test 3</a>
                </li>
            </ul>
        </div>
    </div>

    <div class="row mt-2 d-flex" id="inputSplitTest">
        <div class="col-2">
            <div class="form-floating">
                <select class="form-select" id="floatingSelect" aria-label="Floating label select example" required>
                    <option value="1" selected>Test 1</option>
                    <option value="2">Test 2</option>
                    <option value="3">Test 3</option>
                    <option value="4">Test 4</option>
                </select>
                <label for="floatingSelect">Choose test</label>
            </div>
        </div>
        <div class="col-2">
            <div class="input-group">
                <span class="input-group-text">Name</span>
                <input for="fileName" id="inputNameSplit" type="text" aria-label="Name test" class="form-control" required>
                <div class="invalid-feedback">Please provide a valid name.</div>
            </div>
        </div>
        <div class="col-2">
            <div class="input-group">
                <span class="input-group-text">Start test</span>
                <input id="inputStartSplit" type="number" aria-label="Start test" class="form-control" required>
                <div class="invalid-feedback">Please provide a valid start value.</div>
            </div>
        </div>
        <div class="col-2">
            <div class="input-group">
                <span class="input-group-text">End test</span>
                <input id="inputEndSplit" type="number" aria-label="End test" class="form-control" required>
                <div class="invalid-feedback">Please provide a valid end value.</div>
            </div>
        </div>
        <div class="col-2">
            <div class="col-auto">
<!--                <button type="submit" class="btn btn-dark btn-lg" id="splitTest">Split Test</button>-->
                <button type="button" class="btn btn-dark btn-lg" id="splitTest">Split Test</button>
            </div>
        </div>
        <div class="ms-auto col-1">
            <div class="col-auto">
<!--                <button type="submit" class="btn btn-outline-danger btn-lg" id="deleteTest">Delete</button>-->
                <button type="button" class="btn btn-outline-danger btn-lg" id="deleteTest">Delete</button>
            </div>
        </div>
    </div>

    <div class="row mt-2" id="principalGraphic">
        <div class="row mt-5 justify-content-center" style="display: none;" id="spinner">
            <div class="col-2">
                <div class="spinner-border text-secondary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>

        <div class="accordion" id="accordionPanelsStayOpenExample" style="display: none;" >
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="false" aria-controls="panelsStayOpen-collapseOne">
                        Accelerometer data
                    </button>
                </h2>
                <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <canvas id="accelerometerGraphic"></canvas>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                        Gyroscope data
                    </button>
                </h2>
                <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <canvas id="gyroscopeGraphic"></canvas>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false" aria-controls="panelsStayOpen-collapseThree">
                        Quaternion data
                    </button>
                </h2>
                <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <canvas id="quaternionGraphic"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Modal -->
<form method="post" enctype="multipart/form-data" id="formUploadFile">
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" enctype="multipart/form-data" action="/">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Select a CSV file</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div>
                            <label for="formFileLg" class="form-label"></label>
                            <input class="form-control form-control-lg" id="formFileLg" type="file" name="file">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeUploadModal">Close</button>
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</form>
<form name="formSplit" id="formSplitId" action="/split-file" method="POST">
    <input id="start" name="start" type="hidden">
    <input id="end" name="end" type="hidden">
    <input id="fileName" name="fileName" type="hidden">
</form>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
</body>
</html>